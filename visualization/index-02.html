<!DOCTYPE html>
<html>
<head>
	<title>MatViz</title>
	<style>
		canvas {
			border: 1px solid black;
		}
		table {
			border-collapse: collapse;
			margin: auto;
		}
		td {
			width: 25px;
			height: 25px;
			text-align: center;
			vertical-align: top;
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<div>
		<fieldset>
			<legend>Choose JSON file, experiment and frame: </legend>
			<input type="file" onchange="readFile()" />

			<label for="expList">Experiment:</label>
			<select id="expList" onchange = "setPage()" >
				<option> ---Choose experiment--- </option>
			</select>

			<label for="frameList">&nbsp;Frame:</label>
			<select id="frameList" onchange = "setFrame()" >
				<option> ---Choose frame--- </option>
			</select>

			<button onclick="gotoFrame(0)">&lt; Prev</button>
			<button onclick="gotoFrame(1)">Next &gt;</button>
			<!-- <br/> -->
		</fieldset>
		<fieldset>
			<legend>Experiment comments: </legend>
			<p class="comment" id="expComment">Experiment comment here.</p>
			<p class="comment" id="frameComment">Frame comment here.</p>
		</fieldset>
		<fieldset>
			<legend>Display settings: </legend>
			<label for="checkboxVerbose">Verbose:</label><input type="checkbox" id="checkboxVerbose" checked>
			<label for="inputZoom">&nbsp;Zoom:</label><input type="text" id="inputZoom" value="3.0">
			<button onclick="clickRefresh()">Refresh</button>
		</fieldset>
	</div>
	<br>
	<table id="matTable">
		<tr>
			<td></td>
			<td>
				<canvas id="canvas-C"></canvas>
				C
			</td>
		</tr>
		<tr>
			<td>
				<canvas id="canvas-B"></canvas>
				B
			</td>
			<td>
				<canvas id="canvas-A"></canvas>
				A
			</td>
		</tr>
	</table>
</body>

<script>
	var inputZoom = document.getElementById("inputZoom");
	var checkboxVerbose = document.getElementById("checkboxVerbose");
	var settingsObj = '';
	var matList = [];
	var matTable = document.getElementById("matTable");
	var expList = document.getElementById("expList");
	var frameList = document.getElementById("frameList");
	var expComment = document.getElementById("expComment");
	var frameComment = document.getElementById("frameComment");
	
	function readFile() {
		const [file] = document.querySelector("input[type=file]").files;
		const reader = new FileReader();
		reader.addEventListener("load", () => {
				settingsObj = JSON.parse(reader.result);
				setExpList();
			},
			false
		);
		if (file) {
			reader.readAsText(file);
		}
	}

	function readFileAuto() {
		fetch('settings.json')
			.then(response => response.json())
			.then(jsonResponse => {
				console.log(jsonResponse);
				settingsObj = jsonResponse;
				setExpList();
			})
			.catch((e) => console.error(e));
	}

	window.onload = (event) => {
		console.log("page is fully loaded");
		readFileAuto();
	};

	function setExpList() {
		// reset list
		expList.innerHTML = "<option> ---Choose experiment--- </option>";
		for (const exp of settingsObj.experiments) {
			const option = document.createElement("option");
			option.text = exp.name;
			option.setAttribute("value", exp.name);
			expList.appendChild(option);
		}
	}

	function setPage(refresh = false) {
		const expName = expList.options[expList.selectedIndex].text;
		// reset list
		frameList.innerHTML = "<option> ---Choose frame--- </option>";
		for (const exp of settingsObj.experiments) {
			if (exp.name == expName) {
				// set comment
				expComment.innerText = exp.comment;
				// set zoom (will not overwrite when clicking Refresh)
				if (!refresh) {
					inputZoom.value = exp.zoom;
				}
				// set frames
				setFrameList(exp);
				// set table
				setTable(exp);
			}
		}
	}

	function setFrameList(expObj) {
		// reset list
		frameList.innerHTML = "<option> ---Choose frame--- </option>";
		// add numbers to frameList
		for (let i = 1; i <= expObj.frames; i++) {
			const option = document.createElement("option");
			option.text = i;
			option.setAttribute("value", i);
			frameList.appendChild(option);
		}
	}

	function setTable(expObj) {
		// reset table
		matList = [];
		matTable.innerHTML = "";
		var locRowMax = 0;
		var locColMax = 0;
		// add matrix configs to matList
		for (const mat of expObj.matrices) {
			matList.push(
				{
					name: mat.name,
					comment: mat.comment,
					numRow: mat.numRow,
					numCol: mat.numCol,
					locRow: mat.locRow,
					locCol: mat.locCol,
					invRow: mat.invRow,
					invCol: mat.invCol,
					transpose: mat.transpose
				}
			)
			if (mat.locRow > locRowMax) {
				locRowMax = mat.locRow;
			}
			if (mat.locCol > locColMax) {
				locColMax = mat.locCol;
			}
		}
		// build matTable
		for (var r = 1; r <= locRowMax; r++) {
			const row = matTable.insertRow();
			for (var c = 1; c <= locColMax; c++) {
				const cell = row.insertCell();
				const mat = matList.filter(function (entry) { return entry.locRow == r && entry.locCol == c; });
				if (mat.length > 0) {
					// add canvas and text to matTable
					const canvas = document.createElement("canvas");
					canvas.setAttribute("id", "canvas-" + mat[0].name);
					var str = mat[0].name + ': ' + mat[0].comment;
					str += ' [' + mat[0].numRow + 'x' + mat[0].numCol + ']';
					if (mat[0].transpose) {
						str += ' [transposed]';
					}
					if (mat[0].invRow) {
						str += ' [row-inversed]';
					}
					if (mat[0].invCol) {
						str += ' [col-inversed]';
					}
					// append canvas
					cell.appendChild(canvas);
					// append text
					if (checkboxVerbose.checked) {
						const text = document.createTextNode(str);
						cell.appendChild(text);
					}
					row.appendChild(cell);
				}
			}
		}
	}

	function setFrame() {
		const frameID = frameList.options[frameList.selectedIndex].text;
		if (frameID < 1) {
			return 0;
		}
		for (const mat of matList) {
			var id = "canvas-" + mat.name;
			var numRow = mat.transpose ? mat.numCol : mat.numRow;
			var numCol = mat.transpose ? mat.numRow : mat.numCol;
			var zoom = inputZoom.value;
			setCanvas(id, numRow, numCol, zoom);
		}
	}

	function setCanvas(id, m, n, zoom) {
		var canvas = document.getElementById(id);
        canvas.height = m * zoom;
        canvas.width = n * zoom;
		var ctx = canvas.getContext("2d");
        ctx.scale(zoom, zoom);
		for (var i = 0; i < m; i++) {
			for (var j = 0; j < n; j++) {
                ctx.fillStyle = (Math.floor(Math.random() * 2) == 0) ? "rgba(225,225,225,0.5)" : "rgba(225,0,0,0.5)";
				ctx.fillRect(j, i, 1, 1);
			}
		}
	}

	function clickRefresh() {	
		const frameID = frameList.selectedIndex;
		setPage(refresh = true);
		frameList.selectedIndex = frameID;
		setFrame();
	}

	function gotoFrame(action) {
		const frameID = frameList.selectedIndex;
		if (frameID < 1) {
			return 0;
		}
		if (action == 0 && frameID > 1) {
			frameList.selectedIndex = frameID - 1;
			setFrame();
		}
		if (action == 1 && frameID < frameList.options.length - 1) {
			frameList.selectedIndex = frameID + 1;
			setFrame();
		}
	}

</script>

</html>